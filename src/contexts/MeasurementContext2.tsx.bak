// src/contexts/MeasurementContext.tsx
import { createContext, useContext, useState, useEffect, ReactNode } from "react";
import { Measurement } from "@/services/api"; // importar do api.ts
import { toast } from "@/hooks/use-toast";
import { Button } from "@/components/ui/button";
import { getMeasurements, addMeasurement as addRemote, deleteMeasurement as deleteRemote, ApiResponse } from "@/services/api";

interface MeasurementContextType {
  measurements: Measurement[];
  addMeasurement: (measurement: Omit<Measurement, "id">) => Promise<void>;
  deleteMeasurement: (id: number) => Promise<void>;
}

const MeasurementContext = createContext<MeasurementContextType | undefined>(undefined);

export const MeasurementProvider = ({ children }: { children: ReactNode }) => {
  const [measurements, setMeasurements] = useState<Measurement[]>([]);

  // üîÑ Carrega dados da planilha ao iniciar
  useEffect(() => {
    (async () => {
      try {
        const data = await getMeasurements();
        setMeasurements(data);
      } catch (err) {
        console.error("Erro ao buscar medi√ß√µes:", err);
        toast({
          title: "Erro ao carregar dados",
          description: "N√£o foi poss√≠vel conectar √† planilha Google.",
        });
      }
    })();
  }, []);

  // ‚ûï Adiciona nova medi√ß√£o (POST)
  const addMeasurement = async (newMeasurement: Omit<Measurement, "id">) => {
    try {
      const res: ApiResponse = await addRemote(newMeasurement);
      if (res.success) {
        toast({ title: "Medi√ß√£o salva", description: "Os dados foram registrados com sucesso." });
        const updated = await getMeasurements();
        setMeasurements(updated);
      } else {
        toast({ title: "Erro", description: res.error || "Falha ao adicionar medi√ß√£o." });
      }
    } catch (err) {
      toast({ title: "Erro", description: "Falha ao conectar √† planilha." });
    }
  };

  // üóëÔ∏è Exclui medi√ß√£o (DELETE)
  const deleteMeasurement = async (id: number) => {
    const deletedMeasurement = measurements.find(m => m.id === id);
    if (!deletedMeasurement) return;

    // Remove localmente primeiro
    setMeasurements(measurements.filter(m => m.id !== id));

    toast({
      title: "Medi√ß√£o exclu√≠da",
      description: "A medi√ß√£o foi removida do hist√≥rico",
      action: (
        <Button
          variant="outline"
          size="sm"
          onClick={() => {
            setMeasurements(prev => [...prev, deletedMeasurement].sort((a, b) => (a.id ?? 0) - (b.id ?? 0)));
            toast({
              title: "Medi√ß√£o restaurada localmente",
              description: "A restaura√ß√£o n√£o envia dados √† planilha.",
            });
          }}
        >
          Desfazer
        </Button>
      ),
    });

    try {
      const res: ApiResponse = await deleteRemote(id);
      if (!res.success) {
        console.error("Erro ao excluir na planilha:", res);
        toast({ title: "Erro", description: "N√£o foi poss√≠vel excluir da planilha." });
      }
    } catch (err) {
      toast({ title: "Erro", description: "Falha de conex√£o com a planilha." });
    }
  };

  return (
    <MeasurementContext.Provider value={{ measurements, addMeasurement, deleteMeasurement }}>
      {children}
    </MeasurementContext.Provider>
  );
};

// Hook para usar o contexto
export const useMeasurements = () => {
  const context = useContext(MeasurementContext);
  if (!context) throw new Error("useMeasurements must be used within MeasurementProvider");
  return context;
};
